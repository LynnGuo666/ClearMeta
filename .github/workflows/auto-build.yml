name: Auto Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # å½“æ¨é€æ ‡ç­¾æ—¶ä¹Ÿè§¦å‘æ„å»º
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg exiftool

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install ffmpeg exiftool

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # åœ¨ Windows ä¸Šå®‰è£… FFmpeg å’Œ exiftool
        choco install ffmpeg exiftool -y

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Test application
      run: |
        python -c "import main; print('Application imports successfully')"

    - name: Build executable (Ubuntu/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        pyinstaller --onefile \
          --windowed \
          --name "ClearMeta" \
          --add-data "sponsor_qr.png:." \
          --hidden-import "PyQt5.QtCore" \
          --hidden-import "PyQt5.QtWidgets" \
          --hidden-import "PyQt5.QtGui" \
          --hidden-import "PIL" \
          --hidden-import "piexif" \
          main.py

    - name: Build executable (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        pyinstaller --onefile --windowed --name "ClearMeta" --add-data "sponsor_qr.png;." --hidden-import "PyQt5.QtCore" --hidden-import "PyQt5.QtWidgets" --hidden-import "PyQt5.QtGui" --hidden-import "PIL" --hidden-import "piexif" main.py

    - name: Create portable package (Ubuntu/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        mkdir -p release
        cp dist/ClearMeta release/
        cp README.md release/
        cp PNG_INFO_æ¸…ç†è¯´æ˜.md release/
        if [ -f sponsor_qr.png ]; then cp sponsor_qr.png release/; fi
        cd release
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          tar -czf ../ClearMeta-Linux-x64.tar.gz *
        else
          tar -czf ../ClearMeta-macOS-x64.tar.gz *
        fi

    - name: Create portable package (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        mkdir release
        copy dist\ClearMeta.exe release\
        copy README.md release\
        copy PNG_INFO_æ¸…ç†è¯´æ˜.md release\
        if exist sponsor_qr.png copy sponsor_qr.png release\
        cd release
        7z a ..\ClearMeta-Windows-x64.zip *

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ClearMeta-${{ matrix.os }}
        path: |
          ClearMeta-*.tar.gz
          ClearMeta-*.zip
        retention-days: 30

  # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼Œåˆ›å»ºæ­£å¼å‘å¸ƒ
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ClearMeta ${{ github.ref }}
        body: |
          ## ClearMeta è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          ### åŠŸèƒ½ç‰¹ç‚¹
          - ğŸ¤– AI å›¾ç‰‡å…ƒæ•°æ®æ£€æµ‹ä¸æ¸…ç†
          - ğŸ“ PNG Info ä¸“é—¨æ˜¾ç¤ºä¸æ¸…ç†
          - ğŸ”§ ä¸‰å±‚æ¸…ç†æœºåˆ¶ï¼ˆFFmpegã€exiftoolã€Pythonï¼‰
          - ğŸ¨ æ”¯æŒæ ¼å¼è½¬æ¢ï¼ˆJPG/PNGï¼‰
          - ğŸ“‹ æ‹–æ‹½æ·»åŠ æ–‡ä»¶/æ–‡ä»¶å¤¹
          
          ### ç³»ç»Ÿè¦æ±‚
          - **Linux**: å»ºè®®å®‰è£… FFmpeg å’Œ exiftool è·å¾—æœ€ä½³æ•ˆæœ
          - **Windows**: å»ºè®®å®‰è£… FFmpeg å’Œ exiftool è·å¾—æœ€ä½³æ•ˆæœ
          - **macOS**: å»ºè®®å®‰è£… FFmpeg å’Œ exiftool è·å¾—æœ€ä½³æ•ˆæœ
          
          ### ä¸‹è½½è¯´æ˜
          - `ClearMeta-Linux-x64.tar.gz`: Linux ç‰ˆæœ¬
          - `ClearMeta-Windows-x64.zip`: Windows ç‰ˆæœ¬
          - `ClearMeta-macOS-x64.tar.gz`: macOS ç‰ˆæœ¬
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å‹ç¼©åŒ…
          2. è§£å‹åè¿è¡Œ ClearMeta å¯æ‰§è¡Œæ–‡ä»¶
          3. æ‹–æ‹½å›¾ç‰‡æˆ–é€‰æ‹©æ–‡ä»¶å¤¹å¼€å§‹æ¸…ç†
          
        draft: false
        prerelease: false
    
    - name: Upload Release Assets
      run: |
        # ä¸Šä¼ æ‰€æœ‰æ„å»ºçš„æ–‡ä»¶åˆ°å‘å¸ƒé¡µé¢
        for file in ClearMeta-*/*.{tar.gz,zip}; do
          if [ -f "$file" ]; then
            echo "Uploading $file"
            # è¿™é‡Œéœ€è¦ä½¿ç”¨ GitHub CLI æˆ–å…¶ä»–æ–¹å¼ä¸Šä¼ æ–‡ä»¶
          fi
        done
